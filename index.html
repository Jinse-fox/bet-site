<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">

<title>è³­ã‘ãƒãƒƒãƒ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body{font-size:18px;font-family:sans-serif}
button,input{font-size:18px;width:100%;margin:5px 0}
.player{border:1px solid #ccc;padding:10px;margin:10px 0}
</style>

</head>
<body>
  
<h2>è³­ã‘ãƒãƒƒãƒ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>

<div style="display:flex; gap:10px;">
  <select id="groupSelect" onchange="changeGroup()">
    <option value="group-1">ã‚°ãƒ«ãƒ¼ãƒ—1</option>
  </select>
  <button onclick="addGroup()">ï¼‹ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ</button>
  <button onclick="deleteGroup()">ï¼å‰Šé™¤</button>
</div>

<input id="name" placeholder="åå‰">
<input id="start" type="number" value="100">
<button onclick="add()">è¿½åŠ </button>

<div id="players"></div>
<div id="buttons"></div>
<div id="history"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyB1RZdBCPBjWCKlWOhL4d89peDVkV3zx18",
  authDomain: "bet-app-6ae74.firebaseapp.com",
  projectId: "bet-app-6ae74",
  storageBucket: "bet-app-6ae74.firebasestorage.app",
  messagingSenderId: "1086926403037",
  appId: "1:1086926403037:web:61dd6d59b970a10279b234",
  measurementId: "G-04VXJL8KSZ"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let ref = db.collection("game").doc("main");

let unsubscribe = null;

function getGroups() {
  return JSON.parse(localStorage.getItem("groupList")) || [];
}

function saveGroups(list) {
  localStorage.setItem("groupList", JSON.stringify(list));
}
 
const players = document.getElementById("players");
const buttons = document.getElementById("buttons");
const history = document.getElementById("history");

function add(){

 const nameInput = document.getElementById("name");
 const startInput = document.getElementById("start");

 const n = nameInput.value.trim();
 const p = Number(startInput.value || 0);

 if(!n){
  alert("åå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");
  return;
 }

 ref.set({
  players: firebase.firestore.FieldValue.arrayUnion({
   name:n,
   point:p,
   bet:0
  })
 },{merge:true});
}

function bet(i,v){
 ref.get().then(s=>{
  let d=s.data();
  d.players[i].bet=Number(v);
  ref.set(d, { merge: true });
 });
}

function win(i){
 ref.get().then(s=>{
  let d=s.data();
  let t=0;
  d.players.forEach(p=>{t+=p.bet;p.point-=p.bet});
  d.players[i].point+=t;
  d.players.forEach(p=>p.bet=0);
  d.history=(d.history||"")+`<div>${d.players[i].name} å‹åˆ© +${t}</div>`;
  ref.set(d, { merge: true });
 });
}
  
function removePlayer(i) {
  const check = confirm("ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ");
  if (!check) return;

  ref.get().then(s => {
    let d = s.data();
    // é…åˆ—ã‹ã‚‰æŒ‡å®šã—ãŸç•ªå·(i)ã®è¦ç´ ã‚’1ã¤å‰Šé™¤
    d.players.splice(i, 1);
    
    // æ›´æ–°ã•ã‚ŒãŸé…åˆ—ã‚’Firestoreã«ä¿å­˜
    ref.set(d, { merge: true });
  });
}
  
function render(d){
  players.innerHTML = "";
  buttons.innerHTML = "";
  history.innerHTML = d.history || "";

  d.players?.forEach((p, i) => {
    // ãƒ¡ãƒ³ãƒãƒ¼è¡¨ç¤ºéƒ¨åˆ†ã«å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
    players.innerHTML += `
    <div style="margin-bottom:10px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span><b>${p.name}</b> : ${p.point}pt / BET:${p.bet || 0}pt</span>
        <button onclick="removePlayer(${i})" style="width: auto; background: #ff4d4d; color: white; border: none; padding: 2px 8px; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
      </div>
      <input type="number" placeholder="BETé¡ã‚’å…¥åŠ›" onchange="bet(${i},this.value)">
    </div>
    `;

    buttons.innerHTML += `<button onclick="win(${i})">ğŸ† ${p.name} å‹åˆ©</button>`;
  });
}

function resetGame(){
 if(!confirm("å…¨å“¡ã®ãƒã‚¤ãƒ³ãƒˆã¨å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;

 ref.set({
  players: [],
  history: ""
 });
}

function changeGroup(){
  const name = document.getElementById("groupSelect").value;
 
  if(unsubscribe){
    unsubscribe();
  }
  
  ref = db.collection("game").doc(name);

unsubscribe = ref.onSnapshot(s=>{
    if(!s.exists){
      render({players:[], history:""});
      return;
    }
    render(s.data());
  });
}

window.onload = function(){
  const select = document.getElementById("groupSelect");
  const saved = getGroups();

  saved.forEach(name=>{
    const option = document.createElement("option");
    option.value = name;
    option.textContent = name;
    select.appendChild(option);
  });

  changeGroup();
};

function addGroup(){
  const name = prompt("ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  if(!name) return;

  const select = document.getElementById("groupSelect");

  // é‡è¤‡ãƒã‚§ãƒƒã‚¯
  if([...select.options].some(o => o.value === name)){
    alert("åŒã˜åå‰ãŒã‚ã‚Šã¾ã™");
    return;
  }

  const option = document.createElement("option");
  option.value = name;
  option.textContent = name;
  select.appendChild(option);

  // localStorageã«ä¿å­˜
  const list = getGroups();
  list.push(name);
  saveGroups(list);

  select.value = name;
  changeGroup();
}

function deleteGroup(){
  const select = document.getElementById("groupSelect");
  const name = select.value;

  if(!confirm(name + " ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

  db.collection("game").doc(name).delete();

  // localStorageã‹ã‚‰å‰Šé™¤
  let list = getGroups();
  list = list.filter(n => n !== name);
  saveGroups(list);

  select.remove(select.selectedIndex);

  if(select.options.length > 0){
    changeGroup();
  }
}

</script>

<button onclick="resetGame()" style="margin-top:20px;font-size:20px;padding:10px">
ğŸ”„ å…¨ãƒªã‚»ãƒƒãƒˆ
</button>

</body>
</html>










