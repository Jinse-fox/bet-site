<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>è³­ã‘ãƒãƒƒãƒ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
  body{font-size:18px;font-family:sans-serif; background: #f4f4f4; padding: 10px;}
  .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  button,input,select{font-size:16px; width:100%; margin:5px 0; padding: 10px; box-sizing: border-box;}
  .player{border:2px solid #eee; padding:15px; margin:10px 0; border-radius: 8px; position: relative;}
  .oya-active { border-color: #ffc107; background: #fff9e6; }
  .debt-active { border-color: #ff4d4d; background: #fff0f0; }
  .oya-badge { background: #ffc107; color: black; font-weight: bold; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px; }
  .debt-badge { background: #ff4d4d; color: white; font-weight: bold; padding: 2px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px; }
  .history-box { background: #eee; padding: 10px; border-radius: 5px; max-height: 200px; overflow-y: auto; font-size: 14px; margin-top: 20px; }
  .delete-btn { width: auto; background: #ddd; color: #333; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; float: right; }
  .settle-btn { background: #4caf50; color: white; font-weight: bold; font-size: 20px; margin-top: 20px;}
  
  /* å€Ÿé‡‘ãƒ»è¿”æ¸ˆã‚¨ãƒªã‚¢ã®ã‚¹ã‚¿ã‚¤ãƒ« */
  .money-action-area { margin-top: 10px; padding: 10px; border-radius: 5px; }
  .borrow-bg { background: #ffebeb; }
  .repay-bg { background: #e8f5e9; }
  .borrow-btn { background: #ff4d4d; color: white; font-weight: bold; margin: 0; flex: 1; }
  .repay-btn { background: #43a047; color: white; font-weight: bold; margin: 0; flex: 1; }
</style>
</head>
<body>

<div class="container">
  <h2>ğŸ² è³­ã‘ãƒãƒƒãƒ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h2>

  <div style="display:flex; gap:10px;">
    <select id="groupSelect" onchange="changeGroup()">
      <option value="group-1">ã‚°ãƒ«ãƒ¼ãƒ—1</option>
    </select>
    <button style="width:auto;" onclick="addGroup()">ï¼‹</button>
    <button style="width:auto;" onclick="deleteGroup()">ï¼</button>
  </div>

  <div style="display:flex; gap:5px;">
    <input id="name" placeholder="åå‰" style="flex:2;">
    <input id="start" type="number" value="100" style="flex:1;">
    <button onclick="add()" style="flex:1;">å‚åŠ </button>
  </div>

  <div id="players"></div>
  <div id="buttons"></div>
  
  <div class="history-box" id="history"></div>

  <button onclick="resetGame()" style="background:#888; color:white; margin-top:40px;">ğŸ”„ å…¨ãƒªã‚»ãƒƒãƒˆ</button>
</div>

<script>
// --- Firebase è¨­å®š ---
const firebaseConfig = {
  apiKey: "AIzaSyB1RZdBCPBjWCKlWOhL4d89peDVkV3zx18",
  authDomain: "bet-app-6ae74.firebaseapp.com",
  projectId: "bet-app-6ae74",
  storageBucket: "bet-app-6ae74.firebasestorage.app",
  messagingSenderId: "1086926403037",
  appId: "1:1086926403037:web:61dd6d59b970a10279b234",
  measurementId: "G-04VXJL8KSZ"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let ref = db.collection("game").doc("main");
let unsubscribe = null;

// --- ãƒãƒ³ãƒãƒ­å½¹ã®è¨­å®š ---
const YAKU_CONFIG = {
  "pinzoro": { name: "ãƒ”ãƒ³ã‚¾ãƒ­(111)", mult: 5, score: 100 },
  "arashi2": { name: "ã‚¢ãƒ©ã‚·(222)",   mult: 3, score: 95 },
  "arashi3": { name: "ã‚¢ãƒ©ã‚·(333)",   mult: 3, score: 94 },
  "arashi4": { name: "ã‚¢ãƒ©ã‚·(444)",   mult: 3, score: 93 },
  "arashi5": { name: "ã‚¢ãƒ©ã‚·(555)",   mult: 3, score: 92 },
  "arashi6": { name: "ã‚¢ãƒ©ã‚·(666)",   mult: 3, score: 91 },
  "shigoro": { name: "ã‚·ã‚´ãƒ­(456)",   mult: 2, score: 80 },
  "p6":      { name: "6ã®ç›®",         mult: 1, score: 6 },
  "p5":      { name: "5ã®ç›®",         mult: 1, score: 5 },
  "p4":      { name: "4ã®ç›®",         mult: 1, score: 4 },
  "p3":      { name: "3ã®ç›®",         mult: 1, score: 3 },
  "p2":      { name: "2ã®ç›®",         mult: 1, score: 2 },
  "p1":      { name: "1ã®ç›®",         mult: 1, score: 1 },
  "none":    { name: "å½¹ãªã—",        mult: 1, score: 0 },
  "shomben": { name: "ã‚·ãƒ§ãƒ³ãƒ™ãƒ³",    mult: 1, score: 0 },
  "hifumi":  { name: "ãƒ’ãƒ•ãƒŸ(123)",   mult: 2, score: -1 }
};

// --- é–¢æ•°ç¾¤ ---

function add(){
  const n = document.getElementById("name").value.trim();
  const p = Number(document.getElementById("start").value || 0);
  if(!n) return alert("åå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„");

  ref.set({
    players: firebase.firestore.FieldValue.arrayUnion({
      name:n, point:p, bet:0, yaku:"none", isOya: false, debt: 0
    })
  },{merge:true});
  document.getElementById("name").value = "";
}

function removePlayer(i) {
  if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  ref.get().then(s => {
    let d = s.data();
    d.players.splice(i, 1);
    ref.set(d, { merge: true });
  });
}

function bet(i, v){
  ref.get().then(s => {
    let d = s.data();
    d.players[i].bet = Number(v);
    ref.set(d, { merge: true });
  });
}

function setYaku(i, yakuKey){
  ref.get().then(s => {
    let d = s.data();
    d.players[i].yaku = yakuKey;
    ref.set(d, { merge: true });
  });
}

function setOya(index) {
  ref.get().then(s => {
    let d = s.data();
    d.players.forEach((p, i) => p.isOya = (i === index));
    ref.set(d, { merge: true });
  });
}

// å€Ÿé‡‘æ©Ÿèƒ½
function borrowMoney(i) {
  const inputEl = document.getElementById(`borrow-input-${i}`);
  const amount = Number(inputEl.value);
  if(!amount || amount <= 0) return alert("é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  
  ref.get().then(s => {
    let d = s.data();
    d.players[i].point += amount;
    d.players[i].debt = (d.players[i].debt || 0) + amount;
    d.history = `<div>ğŸ’¸ ${d.players[i].name} ãŒ ${amount}pt å€Ÿé‡‘ã—ã¾ã—ãŸ</div>` + (d.history || "");
    ref.set(d, { merge: true });
  });
}

// è¿”æ¸ˆæ©Ÿèƒ½
function repayDebt(i) {
  const inputEl = document.getElementById(`repay-input-${i}`);
  const amount = Number(inputEl.value);
  
  ref.get().then(s => {
    let d = s.data();
    const p = d.players[i];
    
    if(!amount || amount <= 0) return alert("è¿”æ¸ˆé¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    if(amount > p.point) return alert("æ‰€æŒãƒã‚¤ãƒ³ãƒˆãŒè¶³ã‚Šã¾ã›ã‚“");
    if(amount > p.debt) return alert("å€Ÿé‡‘ç·é¡ã‚’è¶…ãˆã¦ã„ã¾ã™");

    p.point -= amount;
    p.debt -= amount;
    d.history = `<div>ğŸ’° ${p.name} ãŒ ${amount}pt è¿”æ¸ˆã—ã¾ã—ãŸ</div>` + (d.history || "");
    ref.set(d, { merge: true });
  });
}

function settleChinchiro() {
  ref.get().then(s => {
    let d = s.data();
    const brokePlayers = d.players.filter(p => p.point <= 0);
    if (brokePlayers.length > 0) {
      alert(`æ‰€æŒé‡‘ãŒ0ä»¥ä¸‹ã®ãƒ¡ãƒ³ãƒãƒ¼ï¼ˆ${brokePlayers.map(p=>p.name).join(", ")}ï¼‰ãŒã„ã‚‹ãŸã‚ç²¾ç®—ã§ãã¾ã›ã‚“ã€‚`);
      return;
    }

    const oyaIndex = d.players.findIndex(p => p.isOya);
    if (oyaIndex === -1) return alert("è¦ªã‚’æ±ºã‚ã¦ãã ã•ã„");
    if (!confirm("ç²¾ç®—ã—ã¾ã™ã‹ï¼Ÿ")) return;

    const oya = d.players[oyaIndex];
    const oyaYaku = YAKU_CONFIG[oya.yaku || "none"];
    let log = `ã€ç²¾ç®—ã€‘è¦ª:${oya.name}(${oyaYaku.name})<br>`;
    let oyaTotalChange = 0;

    d.players.forEach((p, i) => {
      if (i === oyaIndex) return;
      const playerYaku = YAKU_CONFIG[p.yaku || "none"];
      const bet = p.bet || 0;
      let change = 0;

      if (playerYaku.score > oyaYaku.score) {
        change = bet * playerYaku.mult;
        log += `â—¯ ${p.name}: ${playerYaku.name}å‹ (+${change})<br>`;
      } else {
        let mult = Math.max(oyaYaku.mult, playerYaku.name === "ãƒ’ãƒ•ãƒŸ" ? 2 : 1);
        change = -(bet * mult);
        log += `â— ${p.name}: è² ã‘ (${change})<br>`;
      }
      p.point += change;
      oyaTotalChange -= change;
    });

    d.players[oyaIndex].point += oyaTotalChange;
    log += `è¦ªã®åæ”¯: ${oyaTotalChange > 0 ? "+" : ""}${oyaTotalChange}<hr>`;
    d.players.forEach(p => { p.bet = 0; p.yaku = "none"; });
    d.history = log + (d.history || "");
    ref.set(d, { merge: true });
  });
}

function render(d){
  const playersDiv = document.getElementById("players");
  const buttonsDiv = document.getElementById("buttons");
  playersDiv.innerHTML = "";
  buttonsDiv.innerHTML = "";
  document.getElementById("history").innerHTML = d.history || "å±¥æ­´ãªã—";

  d.players?.forEach((p, i) => {
    const isBroke = p.point <= 0;
    const hasDebt = (p.debt || 0) > 0;
    
    playersDiv.innerHTML += `
    <div class="player ${p.isOya ? 'oya-active' : ''} ${isBroke ? 'debt-active' : ''}">
      <button class="delete-btn" onclick="removePlayer(${i})">Ã—</button>
      <div>
        ${p.isOya ? '<span class="oya-badge">è¦ª</span>' : ''}
        ${isBroke ? '<span class="debt-badge">æ‰€æŒé‡‘ãªã—</span>' : ''}
        <b>${p.name}</b> : <span style="font-size:20px; color:${isBroke ? 'red' : 'black'}">${p.point}</span> pt
        <div style="font-size:12px; color:#666;">ï¼ˆå€Ÿé‡‘ç·é¡: ${p.debt || 0}ptï¼‰</div>
      </div>
      
      <div style="display:flex; gap:5px; margin-top:10px;">
        <input type="number" value="${p.bet}" onchange="bet(${i},this.value)" placeholder="BET" style="flex:1">
        <select onchange="setYaku(${i},this.value)" style="flex:2">
          ${Object.keys(YAKU_CONFIG).map(k => `<option value="${k}" ${p.yaku===k?'selected':''}>${YAKU_CONFIG[k].name}</option>`).join('')}
        </select>
        <button onclick="setOya(${i})" style="flex:1; padding:5px; font-size:12px;">è¦ªè¨­å®š</button>
      </div>
      
      ${isBroke ? `
      <div class="money-action-area borrow-bg" style="display:flex; gap:5px;">
        <input type="number" id="borrow-input-${i}" placeholder="å€Ÿã‚Šã‚‹é¡" style="flex:1; margin:0;">
        <button class="borrow-btn" onclick="borrowMoney(${i})">ğŸ’¸ å€Ÿé‡‘</button>
      </div>
      ` : ''}

      ${hasDebt && !isBroke ? `
      <div class="money-action-area repay-bg" style="display:flex; gap:5px;">
        <input type="number" id="repay-input-${i}" placeholder="è¿”ã™é¡" style="flex:1; margin:0;">
        <button class="repay-btn" onclick="repayDebt(${i})">ğŸ’° è¿”æ¸ˆ</button>
      </div>
      ` : ''}
    </div>`;
  });

  if(d.players?.length > 0) {
    buttonsDiv.innerHTML = `<button class="settle-btn" onclick="settleChinchiro()">ğŸ²ç²¾ç®—å®Ÿè¡Œ</button>`;
  }
}

// --- ç®¡ç†ç³» ---
function getGroups() { return JSON.parse(localStorage.getItem("groupList")) || []; }
function saveGroups(list) { localStorage.setItem("groupList", JSON.stringify(list)); }
function changeGroup(){
  const name = document.getElementById("groupSelect").value;
  if(unsubscribe) unsubscribe();
  ref = db.collection("game").doc(name);
  unsubscribe = ref.onSnapshot(s => {
    if(s.exists) render(s.data());
    else render({players:[], history:""});
  });
}
function addGroup(){
  const name = prompt("ã‚°ãƒ«ãƒ¼ãƒ—å");
  if(!name) return;
  const select = document.getElementById("groupSelect");
  const option = document.createElement("option");
  option.value = name; option.textContent = name;
  select.appendChild(option);
  const list = getGroups(); list.push(name); saveGroups(list);
  select.value = name; changeGroup();
}
function deleteGroup(){
  const select = document.getElementById("groupSelect");
  const name = select.value;
  if(!confirm(name + " ã‚’æ¶ˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  db.collection("game").doc(name).delete();
  let list = getGroups(); list = list.filter(n => n !== name); saveGroups(list);
  select.remove(select.selectedIndex);
  if(select.options.length > 0) changeGroup();
}
function resetGame(){
  if(confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) ref.set({ players: [], history: "" });
}
window.onload = () => {
  const select = document.getElementById("groupSelect");
  getGroups().forEach(name => {
    const option = document.createElement("option");
    option.value = name; option.textContent = name;
    select.appendChild(option);
  });
  changeGroup();
};
</script>
</body>
</html>
